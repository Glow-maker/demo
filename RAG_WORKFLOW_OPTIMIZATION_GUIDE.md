# RAGå·¥ä½œæµä¼˜åŒ–å®æ–½æŒ‡å—

## ğŸ¯ ç›®æ ‡

æœ¬æŒ‡å—æä¾›è¯¦ç»†çš„æ­¥éª¤ï¼Œå¸®åŠ©ä½ å°† `rag_qa_dify_optimized.yml` è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œä½¿å…¶æˆä¸ºä¸€ä¸ªå¯ä»¥ç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒçš„RAGå¢å¼ºæ£€ç´¢QAè’¸é¦å·¥ä½œæµã€‚

## ğŸ“¦ æ–‡ä»¶æ¸…å•

- `rag_qa_dify.yml` - åŸå§‹å·¥ä½œæµ
- `rag_qa_dify_optimized.yml` - è‡ªåŠ¨ä¼˜åŒ–åçš„å·¥ä½œæµï¼ˆå·²ä¿®å¤éƒ¨åˆ†é—®é¢˜ï¼‰
- `RAG_WORKFLOW_ANALYSIS.md` - è¯¦ç»†åˆ†ææŠ¥å‘Š
- `RAG_WORKFLOW_OPTIMIZATION_GUIDE.md` - æœ¬å®æ–½æŒ‡å—

## ğŸš€ å¿«é€Ÿå¼€å§‹ï¼ˆ3æ­¥éª¤ï¼‰

### æ­¥éª¤1: å¯¼å…¥ä¼˜åŒ–åçš„å·¥ä½œæµ

1. ç™»å½•Difyå¹³å°
2. è¿›å…¥"å·¥ä½œå®¤" â†’ "å·¥ä½œæµ"
3. ç‚¹å‡»"å¯¼å…¥DSL"
4. é€‰æ‹© `rag_qa_dify_optimized.yml`
5. ç¡®è®¤å¯¼å…¥

### æ­¥éª¤2: åº”ç”¨å…³é”®ä¿®å¤ï¼ˆå¿…é¡»ï¼‰

ä»¥ä¸‹ä¿®å¤å¿…é¡»æ‰‹åŠ¨åº”ç”¨ï¼Œå¦åˆ™å·¥ä½œæµæ— æ³•æ­£å¸¸è¿è¡Œï¼š

#### ä¿®å¤A: æ·»åŠ source_chunkåˆ°å¾ªç¯å˜é‡

**ä½ç½®**: å¾ªç¯èŠ‚ç‚¹ (ID: 1763368375230)

**æ“ä½œ**:
1. ç‚¹å‡»"å¾ªç¯"èŠ‚ç‚¹
2. åœ¨"å¾ªç¯å˜é‡"éƒ¨åˆ†ï¼Œç‚¹å‡»"+ æ·»åŠ å˜é‡"
3. é…ç½®å¦‚ä¸‹ï¼š
   ```
   å˜é‡æ ‡ç­¾: source_chunk
   å˜é‡ç±»å‹: string  
   å€¼æ¥æº: å˜é‡
   å˜é‡è·¯å¾„: start.source_chunk
   ```

#### ä¿®å¤B: æ›´æ–°CoTæ”¹å†™èŠ‚ç‚¹çš„å¼•ç”¨

**ä½ç½®**: CoTæ”¹å†™èŠ‚ç‚¹ (ID: 1763368671011)

**æ“ä½œ**:
1. ç‚¹å‡»"COTæ”¹å†™"èŠ‚ç‚¹
2. æ‰¾åˆ°System Prompt
3. å°† `{{#1763361675335.source_chunk#}}` 
4. æ”¹ä¸º `{{#quality-check-loop.source_chunk#}}`

**æˆ–è€…**ç›´æ¥ç§»é™¤source_chunkå¼•ç”¨ï¼ˆå¦‚æœä¸éœ€è¦ï¼‰

### æ­¥éª¤3: æµ‹è¯•è¿è¡Œ

**æµ‹è¯•è¾“å…¥**:
```json
{
  "query": "ç¥èˆŸåä¸‰å·çš„ä¸»è¦ä»»åŠ¡æ˜¯ä»€ä¹ˆï¼Ÿ",
  "source_chunk": "ç¥èˆŸåä¸‰å·è½½äººé£èˆ¹æ˜¯ä¸­å›½è½½äººèˆªå¤©å·¥ç¨‹å‘å°„çš„ç¬¬åä¸‰è‰˜é£èˆ¹ï¼Œäº2021å¹´10æœˆ16æ—¥å‘å°„ã€‚ä¸»è¦ä»»åŠ¡åŒ…æ‹¬ï¼šä¸å¤©å’Œæ ¸å¿ƒèˆ±å¯¹æ¥ã€å¼€å±•åœ¨è½¨é©»ç•™6ä¸ªæœˆã€è¿›è¡Œ2-3æ¬¡å‡ºèˆ±æ´»åŠ¨ã€å¼€å±•ç©ºé—´ç§‘å­¦å®éªŒç­‰ã€‚"
}
```

**é¢„æœŸè¾“å‡º**:
- status: success
- åŒ…å«ç»“æ„åŒ–çš„ç­”æ¡ˆ
- åŒ…å«æ€ç»´é“¾(CoT)
- åˆ†ç±»æ­£ç¡®

## ğŸ”§ æ¨èä¼˜åŒ–ï¼ˆå¯é€‰ä½†å¼ºçƒˆå»ºè®®ï¼‰

### ä¼˜åŒ–1: æ·»åŠ è´¨é‡åˆ†æ•°è®¡ç®—

**ç›®çš„**: é‡åŒ–è¯„ä¼°ç”Ÿæˆçš„QAå¯¹è´¨é‡ï¼Œä¾¿äºåç»­ç­›é€‰

**å®æ–½æ­¥éª¤**:

1. **åœ¨"æ”¹å†™åCOTæå–RESULT"èŠ‚ç‚¹ä¹‹åæ·»åŠ æ–°çš„CodeèŠ‚ç‚¹**

   èŠ‚ç‚¹é…ç½®ï¼š
   - èŠ‚ç‚¹åç§°: `è®¡ç®—è´¨é‡åˆ†æ•°`
   - èŠ‚ç‚¹ç±»å‹: Code
   - ä»£ç è¯­è¨€: Python3

2. **ä»£ç å†…å®¹**:

```python
def main(
    answer: str,
    cot: str,
    loop_iterations: int,
    check_passed: str,
    retrieval_results: list
) -> dict:
    """
    è®¡ç®—QAå¯¹çš„è´¨é‡åˆ†æ•°ï¼ˆ0-100ï¼‰
    
    å‚æ•°:
        answer: æœ€ç»ˆç­”æ¡ˆ
        cot: æ€ç»´é“¾
        loop_iterations: å®é™…å¾ªç¯æ¬¡æ•°
        check_passed: æœ€ç»ˆæ ¡éªŒæ˜¯å¦é€šè¿‡
        retrieval_results: æ£€ç´¢ç»“æœåˆ—è¡¨
    """
    score = 100.0
    reasons = []
    
    # 1. å¾ªç¯æ¬¡æ•°è¯„åˆ†ï¼ˆè¶Šå°‘è¶Šå¥½ï¼‰
    if loop_iterations == 1:
        reasons.append("ä¸€æ¬¡æ€§é€šè¿‡(+0)")
    elif loop_iterations == 2:
        score -= 5
        reasons.append("ä¸¤æ¬¡è¿­ä»£(-5)")
    elif loop_iterations == 3:
        score -= 15
        reasons.append("ä¸‰æ¬¡è¿­ä»£(-15)")
    elif loop_iterations >= 4:
        score -= 25
        reasons.append(f"{loop_iterations}æ¬¡è¿­ä»£(-25)")
    
    # 2. æœ€ç»ˆæ ¡éªŒç»“æœè¯„åˆ†
    if check_passed != "true":
        score -= 30
        reasons.append("æœªé€šè¿‡æœ€ç»ˆæ ¡éªŒ(-30)")
    
    # 3. ç­”æ¡ˆé•¿åº¦è¯„åˆ†
    answer_len = len(answer)
    if answer_len < 50:
        score -= 25
        reasons.append("ç­”æ¡ˆè¿‡çŸ­(-25)")
    elif answer_len < 100:
        score -= 10
        reasons.append("ç­”æ¡ˆè¾ƒçŸ­(-10)")
    elif answer_len > 2000:
        score -= 15
        reasons.append("ç­”æ¡ˆè¿‡é•¿(-15)")
    
    # 4. æ€ç»´é“¾è´¨é‡è¯„åˆ†
    cot_len = len(cot)
    if cot_len < 20:
        score -= 20
        reasons.append("æ€ç»´é“¾è¿‡çŸ­(-20)")
    elif cot_len > 1500:
        score -= 10
        reasons.append("æ€ç»´é“¾è¿‡é•¿(-10)")
    
    # 5. æ£€ç´¢ç»“æœæ•°é‡è¯„åˆ†
    retrieval_count = len(retrieval_results) if isinstance(retrieval_results, list) else 0
    if retrieval_count < 2:
        score -= 20
        reasons.append("æ£€ç´¢ç»“æœè¿‡å°‘(-20)")
    elif retrieval_count >= 5:
        reasons.append("æ£€ç´¢ç»“æœå……è¶³(+0)")
    
    # 6. ç¡®ä¿åˆ†æ•°åœ¨åˆç†èŒƒå›´
    score = max(0, min(100, score))
    
    # 7. ç¡®å®šè´¨é‡ç­‰çº§
    if score >= 85:
        quality_level = "excellent"
        quality_label = "ä¼˜ç§€"
    elif score >= 70:
        quality_level = "good"
        quality_label = "è‰¯å¥½"
    elif score >= 55:
        quality_level = "fair"
        quality_label = "ä¸€èˆ¬"
    else:
        quality_level = "poor"
        quality_label = "è¾ƒå·®"
    
    return {
        "quality_score": round(score, 1),
        "quality_level": quality_level,
        "quality_label": quality_label,
        "score_breakdown": " | ".join(reasons),
        "answer_length": answer_len,
        "cot_length": cot_len,
        "retrieval_count": retrieval_count
    }
```

3. **é…ç½®è¾“å…¥å˜é‡**:
   ```
   answer: ä» quality-check-loop.answer
   cot: ä» extract-answer-cot.cot  
   loop_iterations: ä» quality-check-loop.iteration_count
   check_passed: ä» parse-quality-result.check_passed
   retrieval_results: ä» knowledge-retrieval.result
   ```

4. **é…ç½®è¾“å‡ºå˜é‡**:
   ```
   quality_score: number
   quality_level: string
   quality_label: string
   score_breakdown: string
   answer_length: number
   cot_length: number
   retrieval_count: number
   ```

5. **è¿æ¥èŠ‚ç‚¹**:
   - ä» `combine-final-result` è¿åˆ° `è®¡ç®—è´¨é‡åˆ†æ•°`
   - ä» `è®¡ç®—è´¨é‡åˆ†æ•°` è¿åˆ° `final-result` (EndèŠ‚ç‚¹)

6. **æ›´æ–°EndèŠ‚ç‚¹**ï¼Œæ·»åŠ è´¨é‡æŒ‡æ ‡åˆ°è¾“å‡º:
   ```yaml
   outputs:
   - variable: text
     value_selector: [combine-final-result, combine_answer]
   - variable: quality_score
     value_selector: [calculate-quality-score, quality_score]
   - variable: quality_level
     value_selector: [calculate-quality-score, quality_level]
   - variable: score_breakdown
     value_selector: [calculate-quality-score, score_breakdown]
   ```

### ä¼˜åŒ–2: æ·»åŠ æ£€ç´¢ç»“æœéªŒè¯

**ç›®çš„**: å¤„ç†çŸ¥è¯†åº“æ£€ç´¢å¤±è´¥æˆ–ç»“æœä¸ºç©ºçš„æƒ…å†µ

**å®æ–½æ­¥éª¤**:

1. **åœ¨"çŸ¥è¯†åº“æ£€ç´¢"èŠ‚ç‚¹ä¹‹åæ·»åŠ CodeèŠ‚ç‚¹**

   èŠ‚ç‚¹é…ç½®ï¼š
   - èŠ‚ç‚¹åç§°: `éªŒè¯æ£€ç´¢ç»“æœ`
   - èŠ‚ç‚¹ç±»å‹: Code

2. **ä»£ç å†…å®¹**:

```python
def main(retrieval_results: list) -> dict:
    """
    éªŒè¯æ£€ç´¢ç»“æœæ˜¯å¦æœ‰æ•ˆ
    """
    if not retrieval_results:
        return {
            "has_results": "false",
            "result_count": 0,
            "error_message": "çŸ¥è¯†åº“æ£€ç´¢æ— ç»“æœ"
        }
    
    result_count = len(retrieval_results)
    
    if result_count < 2:
        return {
            "has_results": "partial",
            "result_count": result_count,
            "error_message": f"æ£€ç´¢ç»“æœè¾ƒå°‘ï¼Œä»…{result_count}æ¡"
        }
    
    return {
        "has_results": "true",
        "result_count": result_count,
        "error_message": ""
    }
```

3. **æ·»åŠ æ¡ä»¶åˆ†æ”¯èŠ‚ç‚¹**

   åœ¨"éªŒè¯æ£€ç´¢ç»“æœ"åæ·»åŠ If-ElseèŠ‚ç‚¹ï¼š
   ```yaml
   æ¡ä»¶1 (has_results): has_results contains "true"
     â†’ ç»§ç»­æ­£å¸¸æµç¨‹ (RAG Answer)
   
   æ¡ä»¶2 (no_results): has_results contains "false"
     â†’ è·³è½¬åˆ°é”™è¯¯å¤„ç† (æ–°å»ºEndèŠ‚ç‚¹)
   ```

4. **æ·»åŠ é”™è¯¯EndèŠ‚ç‚¹**:
   ```yaml
   outputs:
   - variable: error
     value: "çŸ¥è¯†åº“æ£€ç´¢å¤±è´¥"
   - variable: result_count
     value_selector: [validate-retrieval, result_count]
   ```

### ä¼˜åŒ–3: æ”¹è¿›å¾ªç¯æ—©åœæœºåˆ¶

**ç›®çš„**: å½“ç­”æ¡ˆè´¨é‡å·²ç»è¶³å¤Ÿå¥½æ—¶ï¼Œé¿å…ä¸å¿…è¦çš„è¿­ä»£

**å®æ–½æ­¥éª¤**:

1. **ä¿®æ”¹å¾ªç¯èŠ‚ç‚¹çš„Breakæ¡ä»¶**

   ç‚¹å‡»å¾ªç¯èŠ‚ç‚¹ â†’ Breakæ¡ä»¶ â†’ æ·»åŠ æ¡ä»¶ï¼š
   ```yaml
   é€»è¾‘è¿ç®—ç¬¦: OR
   æ¡ä»¶ç»„1:
     - parse-quality-result.check_passed equals "true"
   ```

   è¿™æ ·ï¼Œåªè¦æ ¡éªŒé€šè¿‡ä¸€æ¬¡ï¼Œå°±ä¼šé€€å‡ºå¾ªç¯ã€‚

2. **ï¼ˆå¯é€‰ï¼‰æ·»åŠ è¿ç»­é€šè¿‡è®¡æ•°**

   å¦‚æœå¸Œæœ›"è¿ç»­2æ¬¡é€šè¿‡"æ‰é€€å‡ºï¼Œéœ€è¦ï¼š
   - åœ¨å¾ªç¯ä¸­æ·»åŠ ä¸€ä¸ªAssignerèŠ‚ç‚¹è®°å½•é€šè¿‡æ¬¡æ•°
   - ä¿®æ”¹Breakæ¡ä»¶æ£€æŸ¥è¿ç»­é€šè¿‡æ¬¡æ•°

### ä¼˜åŒ–4: ä¼˜åŒ–Promptæ¨¡æ¿

ä»¥ä¸‹æ˜¯æ”¹è¿›åçš„Promptæ¨¡æ¿ï¼Œå¯ä»¥æ›¿æ¢åŸæœ‰çš„ï¼š

#### é—®é¢˜åˆæ ¼åˆ¤æ–­èŠ‚ç‚¹

**Temperature**: 0.3 (ä»0.7é™ä½)

**System Prompt**:
```
ä½ æ˜¯é—®ç­”è¯„ä¼°ä¸“å®¶ã€‚ä»»åŠ¡ï¼šåˆ¤æ–­ã€é—®é¢˜ã€‘åœ¨ã€ä¸Šä¸‹æ–‡ã€‘ä¸­èƒ½å¦è¢«åˆç†å›ç­”ã€‚

è¯„ä¼°æ ‡å‡†ï¼š
1. ä¸Šä¸‹æ–‡åŒ…å«ç›¸å…³æ ¸å¿ƒä¿¡æ¯
2. å¯åŸºäºä¸Šä¸‹æ–‡ç»™å‡ºåˆç†ç­”æ¡ˆï¼ˆå…è®¸é€‚åº¦æ¨ç†ï¼‰
3. é—®é¢˜æœ¬èº«æ¸…æ™°æ˜ç¡®

è¾“å‡ºJSONæ ¼å¼ï¼ˆä¸è¦å…¶ä»–æ–‡å­—ï¼‰ï¼š
{
  "is_valid": true/false,
  "reason": "åŸå› ï¼ˆ50å­—å†…ï¼‰"
}

ã€ä¸Šä¸‹æ–‡ã€‘ï¼š
{{#context#}}

ã€é—®é¢˜ã€‘ï¼š
{{#start.query#}}
```

#### èˆªå¤©RAGçŸ¥è¯†è’¸é¦èŠ‚ç‚¹

**Temperature**: 0.5 (ä»0.7é™ä½)

**System Prompt**:
```
ä½ æ˜¯èˆªå¤©é¢†åŸŸä¸“å®¶ï¼Œæ“…é•¿å°†ä¸“ä¸šçŸ¥è¯†è½¬åŒ–ä¸ºæ¸…æ™°æ˜“æ‡‚çš„è§£ç­”ã€‚

è¦æ±‚ï¼š
1. åŸºäºæä¾›çš„çŸ¥è¯†ç‰‡æ®µç»™å‡ºå‡†ç¡®ã€å…¨é¢çš„å›ç­”
2. ç»“æ„æ¸…æ™°ã€é€»è¾‘ä¸¥è°¨ã€å±‚æ¬¡åˆ†æ˜
3. ä½¿ç”¨ç®€ä½“ä¸­æ–‡ï¼Œé¿å…è¡Œè¯å †ç Œ
4. ä¸è¦æåŠ"æ£€ç´¢""çŸ¥è¯†åº“"ç­‰å†…éƒ¨æœ¯è¯­
5. ä¿¡æ¯ä¸è¶³æ—¶è¯´æ˜ä¸ç¡®å®šæ€§ï¼Œä¸ç¼–é€ ç»†èŠ‚

è¯·å¯¹ä»¥ä¸‹é—®é¢˜ç»™å‡ºä¸“ä¸šå›ç­”ï¼š

ã€é—®é¢˜ã€‘ï¼š{{#start.query#}}

ã€å‚è€ƒèµ„æ–™ã€‘ï¼š{{#context#}}
```

#### å‡†ç¡®æ€§ä¸å…¨é¢æ€§æ ¡éªŒèŠ‚ç‚¹

**Temperature**: 0.3

**System Prompt**:
```
ä½ æ˜¯QAè´¨æ£€ä¸“å®¶ã€‚ä»»åŠ¡ï¼šæ ¡éªŒå›ç­”çš„å‡†ç¡®æ€§å’Œå®Œæ•´æ€§ã€‚

æ ¡éªŒç»´åº¦ï¼š
1. å‡†ç¡®æ€§ï¼šå›ç­”æ˜¯å¦ä¸å‚è€ƒèµ„æ–™ä¸€è‡´ï¼Œæ— æ˜æ˜¾é”™è¯¯
2. å®Œæ•´æ€§ï¼šæ˜¯å¦è¦†ç›–å…³é”®ä¿¡æ¯ï¼Œé¿å…é—æ¼é‡ç‚¹
3. ç›¸å…³æ€§ï¼šæ˜¯å¦ç´§æ‰£é—®é¢˜ï¼Œæ²¡æœ‰åé¢˜

è¾“å‡ºæ ¼å¼ï¼ˆä»…åŒ…å«ä»¥ä¸‹å†…å®¹ï¼‰ï¼š
- å¦‚æœé€šè¿‡ï¼šcheck_passed
- å¦‚æœä¸é€šè¿‡ï¼šcheck_failed + ç®€è¦è¯´æ˜é—®é¢˜ï¼ˆ100å­—å†…ï¼‰

ã€é—®é¢˜ã€‘ï¼š{{#start.query#}}
ã€å‚è€ƒèµ„æ–™ã€‘ï¼š{{#context#}}
ã€å¾…æ ¡éªŒå›ç­”ã€‘ï¼š{{#quality-check-loop.answer#}}
```

#### å›ç­”æ”¹å†™èŠ‚ç‚¹

**Temperature**: 0.6

**System Prompt** (ç®€åŒ–ç‰ˆ):
```
ä½ æ˜¯èˆªå¤©QAæ”¹å†™ä¸“å®¶ã€‚ä»»åŠ¡ï¼šæ ¹æ®æ ¡éªŒæ„è§æ”¹å†™å›ç­”ã€‚

æ”¹å†™è¦æ±‚ï¼š
1. ä¿®æ­£æ ¡éªŒä¸­æŒ‡å‡ºçš„æ‰€æœ‰é—®é¢˜
2. è¡¥å……é—æ¼çš„å…³é”®ä¿¡æ¯
3. ä¿æŒç»“æ„æ¸…æ™°ã€é€»è¾‘ä¸¥è°¨
4. åˆ é™¤ä¸ç¡®å®šæˆ–é”™è¯¯çš„å†…å®¹
5. ç›´æ¥è¾“å‡ºæ”¹å†™åçš„å›ç­”ï¼Œä¸è¦è§£é‡Šè¿‡ç¨‹

ã€é—®é¢˜ã€‘ï¼š{{#start.query#}}
ã€å‚è€ƒèµ„æ–™ã€‘ï¼š{{#context#}}
ã€åŸå§‹å›ç­”ã€‘ï¼š{{#quality-check-loop.answer#}}
ã€é—®é¢˜æ ¹æºã€‘ï¼š{{#quality-check-loop.source_chunk#}}
ã€æ ¡éªŒæ„è§ã€‘ï¼š{{#quality-validation.text#}}

è¯·è¾“å‡ºæ”¹å†™åçš„å›ç­”ï¼š
```

#### CoTæ”¹å†™èŠ‚ç‚¹

**Temperature**: 0.5

**System Prompt** (ç®€åŒ–ç‰ˆ):
```
ä½ æ˜¯æ€ç»´é“¾ä¼˜åŒ–ä¸“å®¶ã€‚ä»»åŠ¡ï¼šä¼˜åŒ–æ¨ç†è¿‡ç¨‹ã€‚

è¦æ±‚ï¼š
1. å›´ç»•é—®é¢˜å±•å¼€ï¼Œæ­¥éª¤æ¸…æ™°ã€é€»è¾‘ä¸¥å¯†
2. èƒ½åˆç†æ¨å¯¼å‡ºç»™å®šç­”æ¡ˆ
3. ä¸è¦å‡ºç°"ä¼˜åŒ–å""æ ¹æ®ä¸Šæ–‡"ç­‰å…ƒæè¿°
4. ä¸è¦ä½¿ç”¨Markdownæ ¼å¼ï¼Œåªç”¨è‡ªç„¶æ®µè½
5. ç›´æ¥è¾“å‡ºä¼˜åŒ–åçš„æ€ç»´é“¾æ–‡æœ¬

ã€é—®é¢˜ã€‘ï¼š{{#start.query#}}
ã€ç­”æ¡ˆã€‘ï¼š{{#quality-check-loop.answer#}}
ã€åŸå§‹æ€ç»´é“¾ã€‘ï¼š{{#extract-answer-cot.cot#}}
```

### ä¼˜åŒ–5: é™ä½APIè°ƒç”¨æˆæœ¬

**ç­–ç•¥**:

1. **ä½¿ç”¨æ›´ä¾¿å®œçš„æ¨¡å‹**:
   - é—®é¢˜åˆ†ç±»: qwen3-vl-8b-thinking (å·²ä½¿ç”¨)
   - ç»“æœè§£æ: ä¸éœ€è¦thinkingæ¨¡å‹ï¼Œç”¨æ™®é€šæ¨¡å‹
   - è´¨é‡æ ¡éªŒ: qwen3-vl-32b-thinking â†’ qwen3-vl-8b-thinking

2. **ä¼˜åŒ–Tokenä½¿ç”¨**:
   - é™åˆ¶contexté•¿åº¦: åœ¨æ£€ç´¢ç»“æœä¸­åªå–å‰3000 tokens
   - ç²¾ç®€Prompt: å»æ‰å†—ä½™è¯´æ˜
   - é™ä½max_tokens: æ ¹æ®å®é™…éœ€è¦è®¾ç½®åˆç†çš„æœ€å¤§å€¼

3. **æ‰¹é‡å¤„ç†**:
   - ä½¿ç”¨Difyçš„æ‰¹é‡è¿è¡ŒAPI
   - åˆç†è®¾ç½®å¹¶å‘æ•°

## ğŸ“Š æ•ˆæœéªŒè¯

### æµ‹è¯•ç”¨ä¾‹

å‡†å¤‡è‡³å°‘10ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œè¦†ç›–ä¸åŒåœºæ™¯ï¼š

#### æµ‹è¯•ç”¨ä¾‹1: æ ‡å‡†èˆªå¤©é—®é¢˜
```json
{
  "query": "é•¿å¾äº”å·ç«ç®­çš„è¿‘åœ°è½¨é“è¿è½½èƒ½åŠ›æ˜¯å¤šå°‘ï¼Ÿ",
  "source_chunk": "é•¿å¾äº”å·æ˜¯ä¸­å›½æ–°ä¸€ä»£å¤§å‹è¿è½½ç«ç®­ï¼Œè¿‘åœ°è½¨é“è¿è½½èƒ½åŠ›è¾¾25å¨ï¼Œåœ°çƒåŒæ­¥è½¬ç§»è½¨é“è¿è½½èƒ½åŠ›14å¨ã€‚"
}
```

**é¢„æœŸ**: åˆ†ç±»ä¸ºèˆªå¤©é—®é¢˜ï¼Œè´¨é‡åˆ†æ•°>80ï¼Œä¸€æ¬¡é€šè¿‡

#### æµ‹è¯•ç”¨ä¾‹2: ç¼ºå°‘ä¸Šä¸‹æ–‡
```json
{
  "query": "ç¥èˆŸåäº”å·çš„å‘å°„æ—¶é—´ï¼Ÿ",
  "source_chunk": ""
}
```

**é¢„æœŸ**: ä»èƒ½å›ç­”ï¼ˆä»çŸ¥è¯†åº“æ£€ç´¢ï¼‰ï¼Œè´¨é‡åˆ†æ•°60-80

#### æµ‹è¯•ç”¨ä¾‹3: é€šç”¨é—®é¢˜
```json
{
  "query": "Pythonå¦‚ä½•è¯»å–æ–‡ä»¶ï¼Ÿ",
  "source_chunk": ""
}
```

**é¢„æœŸ**: åˆ†ç±»ä¸ºé€šç”¨é—®é¢˜ï¼Œèµ°é€šç”¨å›ç­”åˆ†æ”¯

#### æµ‹è¯•ç”¨ä¾‹4: æ¨¡ç³Šé—®é¢˜
```json
{
  "query": "å®ƒçš„é€Ÿåº¦å¿«å—ï¼Ÿ",
  "source_chunk": "ç¥èˆŸé£èˆ¹çš„æœ€å¤§é£è¡Œé€Ÿåº¦å¯è¾¾7.9å…¬é‡Œ/ç§’ã€‚"
}
```

**é¢„æœŸ**: é—®é¢˜éªŒè¯å¤±è´¥æˆ–è¦æ±‚å¤šæ¬¡æ”¹å†™

#### æµ‹è¯•ç”¨ä¾‹5: å¤æ‚ä¸“ä¸šé—®é¢˜
```json
{
  "query": "æ¶²ä½“ç«ç®­å‘åŠ¨æœºçš„ç‡ƒçƒ§å®¤å‹åŠ›å’Œæ¨åŠ›ä¹‹é—´çš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿ",
  "source_chunk": "æ¶²ä½“ç«ç®­å‘åŠ¨æœºçš„æ¨åŠ›ä¸ç‡ƒçƒ§å®¤å‹åŠ›ã€å–·ç®¡é¢ç§¯æ¯”ç­‰å‚æ•°ç›¸å…³ã€‚ç‡ƒçƒ§å®¤å‹åŠ›è¶Šé«˜ï¼Œåœ¨ç›¸åŒå–·ç®¡æ¡ä»¶ä¸‹æ¨åŠ›è¶Šå¤§ã€‚"
}
```

**é¢„æœŸ**: è´¨é‡æ£€æŸ¥2-3æ¬¡ï¼Œæœ€ç»ˆè´¨é‡åˆ†æ•°70-85

### è¯„ä¼°æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹é‡æ–¹æ³• |
|------|-------|---------|
| é—®é¢˜åˆ†ç±»å‡†ç¡®ç‡ | >95% | äººå·¥æ ‡æ³¨vsç³»ç»Ÿåˆ†ç±» |
| è´¨é‡åˆ†æ•°åˆ†å¸ƒ | 80%åœ¨70åˆ†ä»¥ä¸Š | ç»Ÿè®¡æ‰€æœ‰è¾“å‡º |
| å¹³å‡å¾ªç¯æ¬¡æ•° | <2æ¬¡ | workflowæ—¥å¿— |
| å•æ¬¡è¿è¡Œæ—¶é—´ | <60ç§’ | APIå“åº”æ—¶é—´ |
| æˆåŠŸç‡ | >90% | æˆåŠŸæ•°/æ€»æ•° |
| ç­”æ¡ˆå‡†ç¡®æ€§ | >85% | äººå·¥è¯„ä¼° |

### ç›‘æ§å’Œè°ƒä¼˜

1. **å¯¼å‡ºè¿è¡Œæ—¥å¿—**:
   ```python
   # ä½¿ç”¨Dify APIå¯¼å‡ºworkflowè¿è¡Œè®°å½•
   # åˆ†æè´¨é‡åˆ†æ•°åˆ†å¸ƒã€å¾ªç¯æ¬¡æ•°ç­‰
   ```

2. **A/Bæµ‹è¯•ä¸åŒé…ç½®**:
   - Temperatureå€¼
   - Top_Kå€¼
   - Promptæ¨¡æ¿

3. **æŒç»­ä¼˜åŒ–**:
   - æ”¶é›†badcase
   - ä¼˜åŒ–Prompt
   - è°ƒæ•´è¯„åˆ†æƒé‡

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: å¯¼å…¥åæç¤º"ç¼ºå°‘ä¾èµ–"ï¼Ÿ
A: éœ€è¦åœ¨Difyä¸­å®‰è£…å¯¹åº”çš„æ’ä»¶ï¼š
- langgenius/siliconflow
- langgenius/tongyi

### Q2: è¿è¡Œæ—¶æŠ¥é”™"variable not found"ï¼Ÿ
A: æ£€æŸ¥ï¼š
1. å¾ªç¯å˜é‡æ˜¯å¦æ­£ç¡®é…ç½®
2. å˜é‡è·¯å¾„æ˜¯å¦æ­£ç¡®å¼•ç”¨
3. ä¸Šæ¸¸èŠ‚ç‚¹æ˜¯å¦æ­£å¸¸è¾“å‡º

### Q3: è´¨é‡åˆ†æ•°æ€»æ˜¯å¾ˆä½ï¼Ÿ
A: è°ƒæ•´è¯„åˆ†é€»è¾‘ä¸­çš„æƒé‡ï¼Œæˆ–è€…ï¼š
- é™ä½å¯¹å¾ªç¯æ¬¡æ•°çš„æƒ©ç½š
- æé«˜ç­”æ¡ˆé•¿åº¦çš„å®½å®¹åº¦
- æ£€æŸ¥æ ¡éªŒé€»è¾‘æ˜¯å¦è¿‡äºä¸¥æ ¼

### Q4: æ£€ç´¢ç»“æœæ€»æ˜¯ä¸ºç©ºï¼Ÿ
A: æ£€æŸ¥ï¼š
1. çŸ¥è¯†åº“IDæ˜¯å¦æ­£ç¡®
2. çŸ¥è¯†åº“æ˜¯å¦æœ‰å†…å®¹
3. æŸ¥è¯¢å…³é”®è¯æ˜¯å¦æœ‰æ•ˆ
4. åµŒå…¥æ¨¡å‹æ˜¯å¦æ­£å¸¸

### Q5: å¾ªç¯æ€»æ˜¯è¾¾åˆ°æœ€å¤§æ¬¡æ•°ï¼Ÿ
A: è¯´æ˜æ ¡éªŒä¸€ç›´æœªé€šè¿‡ï¼š
- æ£€æŸ¥æ ¡éªŒPromptæ˜¯å¦åˆç†
- é™ä½æ ¡éªŒæ ‡å‡†
- æ£€æŸ¥æ”¹å†™èŠ‚ç‚¹æ˜¯å¦æœ‰æ•ˆ

## ğŸ“ˆ ç”Ÿäº§ç¯å¢ƒå»ºè®®

### 1. æ‰¹é‡å¤„ç†æœ€ä½³å®è·µ

```python
import requests
import json
from concurrent.futures import ThreadPoolExecutor

def process_batch(qa_pairs, workflow_url, api_key, batch_size=10):
    """
    æ‰¹é‡å¤„ç†QAå¯¹
    """
    results = []
    
    with ThreadPoolExecutor(max_workers=5) as executor:
        futures = []
        for qa in qa_pairs:
            future = executor.submit(
                call_workflow,
                workflow_url,
                api_key,
                qa['query'],
                qa.get('source_chunk', '')
            )
            futures.append(future)
        
        for future in futures:
            try:
                result = future.result(timeout=120)
                results.append(result)
            except Exception as e:
                print(f"Error: {e}")
                results.append({"error": str(e)})
    
    return results

def call_workflow(url, api_key, query, source_chunk):
    """
    è°ƒç”¨Dify workflow
    """
    headers = {
        "Authorization": f"Bearer {api_key}",
        "Content-Type": "application/json"
    }
    
    data = {
        "inputs": {
            "query": query,
            "source_chunk": source_chunk
        }
    }
    
    response = requests.post(url, headers=headers, json=data, timeout=120)
    return response.json()
```

### 2. æ•°æ®ç­›é€‰ç­–ç•¥

```python
def filter_qa_pairs(results, min_score=70):
    """
    æ ¹æ®è´¨é‡åˆ†æ•°ç­›é€‰QAå¯¹
    """
    high_quality = []
    
    for result in results:
        if result.get('quality_score', 0) >= min_score:
            qa_pair = {
                'question': result['query'],
                'answer': result['text'],
                'score': result['quality_score'],
                'source': result.get('source_documents', [])
            }
            high_quality.append(qa_pair)
    
    return high_quality
```

### 3. æˆæœ¬æ§åˆ¶

- æ¯1000æ¬¡è°ƒç”¨é¢„ä¼°æˆæœ¬ï¼šï¿¥50-100ï¼ˆæ ¹æ®æ¨¡å‹ï¼‰
- å»ºè®®å…ˆå°æ‰¹é‡æµ‹è¯•ï¼ˆ100æ¡ï¼‰
- ç›‘æ§Tokenä½¿ç”¨é‡
- ä¼˜åŒ–Promptå‡å°‘æ— æ•ˆè°ƒç”¨

### 4. è´¨é‡ä¿è¯

- å®šæœŸäººå·¥æŠ½æ£€ï¼ˆ10%ï¼‰
- å»ºç«‹åé¦ˆæœºåˆ¶
- æŒç»­ä¼˜åŒ–Prompt
- A/Bæµ‹è¯•ä¸åŒé…ç½®

## ğŸ“ æ€»ç»“

å®Œæˆæœ¬æŒ‡å—çš„æ‰€æœ‰ä¼˜åŒ–åï¼Œä½ å°†è·å¾—ï¼š

âœ… ä¿®å¤äº†æ‰€æœ‰å…³é”®bugçš„ç¨³å®šå·¥ä½œæµ
âœ… å®Œæ•´çš„è´¨é‡è¯„ä¼°ä½“ç³»
âœ… å¥å£®çš„é”™è¯¯å¤„ç†æœºåˆ¶
âœ… ä¼˜åŒ–çš„æˆæœ¬æ•ˆç›Š
âœ… å¯ç”¨äºç”Ÿäº§ç¯å¢ƒçš„RAG QAè’¸é¦ç³»ç»Ÿ

## ğŸ“ ä¸‹ä¸€æ­¥

1. æŒ‰æœ¬æŒ‡å—å®Œæˆæ‰€æœ‰ä¼˜åŒ–
2. ä½¿ç”¨æµ‹è¯•ç”¨ä¾‹éªŒè¯æ•ˆæœ
3. å°æ‰¹é‡è¯•è¿è¡Œ
4. æ”¶é›†åé¦ˆå¹¶æŒç»­æ”¹è¿›
5. é€æ­¥æ‰©å¤§åˆ°ç”Ÿäº§è§„æ¨¡

Good luck! ğŸš€
