# RAG QA Dify 工作流优化项目

## 📁 文件说明

本项目包含针对 Dify RAG 工作流的完整分析、优化和实施指南。

### 工作流文件

| 文件名 | 说明 | 状态 | 推荐使用 |
|--------|------|------|----------|
| `rag_qa_dify.yml` | 原始工作流文件 | 存在多个问题 | ❌ 不推荐 |
| `rag_qa_dify_optimized.yml` | 部分优化版本 | 修复了关键bug | ⚠️ 需手动调整 |
| `rag_qa_dify_complete.yml` | 完全优化版本 | 所有自动修复已应用 | ✅ **推荐** |

### 文档文件

| 文件名 | 说明 |
|--------|------|
| `RAG_WORKFLOW_ANALYSIS.md` | 详细的问题分析报告 |
| `RAG_WORKFLOW_OPTIMIZATION_GUIDE.md` | 分步实施指南 |
| `README_WORKFLOW.md` | 本文件 - 项目总览 |

## 🚀 快速开始

### 方案A：使用完全优化版本（推荐）

1. **导入工作流**
   ```bash
   # 在 Dify 中选择导入 DSL
   # 选择文件: rag_qa_dify_complete.yml
   ```

2. **配置知识库**
   - 确保知识库 ID 正确
   - 测试检索功能

3. **测试运行**
   ```json
   {
     "query": "神舟十三号的主要任务是什么？",
     "source_chunk": "神舟十三号于2021年10月16日发射，主要任务包括与天和核心舱对接、在轨驻留6个月等。"
   }
   ```

4. **验证输出**
   - 检查是否有 `quality_score` 字段
   - 检查 `quality_level` 是否合理
   - 验证答案质量

### 方案B：自己手动优化

如果你想了解优化过程或需要定制化：

1. 阅读 `RAG_WORKFLOW_ANALYSIS.md` 了解问题
2. 按照 `RAG_WORKFLOW_OPTIMIZATION_GUIDE.md` 逐步实施
3. 使用 `rag_qa_dify_optimized.yml` 作为起点

## 🔍 主要问题与修复

### 问题1: source_chunk未使用 ❌ → ✅

**问题**：输入的 `source_chunk` 在问题验证节点中未被使用

**修复**：
- `rag_qa_dify_complete.yml` ✅ 已修复
- 在问题合格判断节点启用了 context
- 正确引用了 source_chunk 变量

### 问题2: CoT改写节点引用错误 ❌ → ✅

**问题**：CoT改写节点引用了未传递的 source_chunk

**修复**：
- `rag_qa_dify_complete.yml` ✅ 已修复
- 将 source_chunk 添加到循环变量
- 更新了节点中的变量引用路径

### 问题3: 缺少质量评分 ❌ → ✅

**问题**：无法量化评估生成的 QA 对质量

**修复**：
- `rag_qa_dify_complete.yml` ✅ 已添加
- 新增质量分数计算节点
- 在最终输出中包含质量指标

### 问题4: Temperature参数过高 ⚠️ → ✅

**问题**：确定性任务使用了过高的 temperature (0.7)

**修复**：
- `rag_qa_dify_complete.yml` ✅ 已优化
- 问题分类：0.7 → 0.3
- 问题验证：0.7 → 0.3
- 质量校验：0.7 → 0.3

### 问题5: 知识检索可优化 ⚠️ → ✅

**问题**：top_k=4 可能召回不足

**修复**：
- `rag_qa_dify_complete.yml` ✅ 已优化
- top_k: 4 → 5

## 📊 工作流对比

### 原始版本 (rag_qa_dify.yml)
```
节点数: 23
已知问题: 7个
可直接使用: ❌ No
```

### 部分优化版本 (rag_qa_dify_optimized.yml)
```
节点数: 23
修复问题: 2个 (source_chunk使用, top_k优化)
需手动修复: 5个
可直接使用: ⚠️ 需额外配置
```

### 完全优化版本 (rag_qa_dify_complete.yml)
```
节点数: 24 (新增质量分数节点)
修复问题: 7个
需手动修复: 0个
可直接使用: ✅ Yes
```

## 🎯 功能特性

### 完全优化版本的特性

✅ **自动质量评分**
- 基于多维度评估（答案长度、思维链质量、检索结果等）
- 输出 0-100 分数和质量等级
- 便于筛选高质量训练数据

✅ **智能问题验证**
- 使用 source_chunk 作为上下文
- 准确判断问题是否可回答
- 避免无效问题进入后续流程

✅ **优化的循环机制**
- source_chunk 正确传递到所有需要的节点
- CoT 改写可以使用完整上下文
- 确保生成高质量答案

✅ **降低的 API 成本**
- 优化了 temperature 参数
- 减少了不必要的 token 消耗
- 提高了确定性任务的效率

✅ **完整的输出信息**
- 最终答案（含思维链）
- 质量分数和等级
- 质量评分明细
- 问题分类信息
- 检索结果引用

## 📖 使用示例

### 输入格式
```json
{
  "query": "天问一号火星探测器的主要科学目标是什么？",
  "source_chunk": "天问一号是中国首次火星探测任务，于2020年7月23日发射。主要科学目标包括：研究火星形貌与地质构造特征、探测火星表面土壤特征与水冰分布、分析火星表面物质组成等。"
}
```

### 输出格式（完全优化版本）
```json
{
  "text": "<think>首先分析天问一号的科学目标...</think>\n天问一号的主要科学目标包括：\n1. 研究火星形貌与地质构造特征\n2. 探测火星表面土壤特征与水冰分布\n3. 分析火星表面物质组成\n...",
  "quality_score": 87.5,
  "quality_level": "excellent",
  "quality_details": "无扣分项",
  "query_is_valid": "true",
  "query_class_name": "航天领域相关问题"
}
```

## 📈 质量评分说明

### 评分维度

| 维度 | 权重 | 说明 |
|------|------|------|
| 答案长度 | 25分 | 过短(<50字)或过长(>2000字)扣分 |
| 思维链质量 | 15分 | 思维链过短扣分 |
| 校验结果 | 25分 | 未通过最终校验扣分 |
| 检索质量 | 15分 | 检索结果过少扣分 |
| 基础分 | 100分 | 满分起点 |

### 质量等级

| 分数范围 | 等级 | 英文标识 | 建议 |
|----------|------|----------|------|
| 85-100 | 优秀 | excellent | 直接使用 |
| 70-84 | 良好 | good | 可以使用 |
| 55-69 | 一般 | fair | 需人工审核 |
| 0-54 | 较差 | poor | 不建议使用 |

## 🔧 常见问题

### Q: 为什么有三个版本的工作流文件？

A: 
- **原始版本**：保留以供参考和对比
- **部分优化版本**：展示自动化修复的过程
- **完全优化版本**：可直接使用的最终版本

### Q: 我应该使用哪个版本？

A: 
- **推荐使用** `rag_qa_dify_complete.yml`
- 如果需要深度定制，参考优化指南手动调整

### Q: 导入后需要额外配置吗？

A: 需要确认：
1. 知识库 ID 是否匹配你的环境
2. API 密钥是否正确配置
3. 模型是否可用

### Q: 如何验证工作流是否正常工作？

A: 使用测试用例：
```json
{
  "query": "测试问题",
  "source_chunk": "测试上下文"
}
```
检查输出中是否包含 `quality_score` 字段。

### Q: 质量分数总是很低怎么办？

A: 可以调整评分逻辑：
1. 修改质量分数计算节点的代码
2. 调整各维度的权重
3. 放宽某些条件的限制

### Q: 可以用于其他领域吗？

A: 可以，但需要修改：
1. 问题分类器的类别定义
2. 知识库配置
3. Prompt 模板（移除航天相关的描述）

## 📚 进一步阅读

1. **详细分析报告**：`RAG_WORKFLOW_ANALYSIS.md`
   - 问题根源分析
   - 影响评估
   - 技术细节

2. **实施指南**：`RAG_WORKFLOW_OPTIMIZATION_GUIDE.md`
   - 分步操作说明
   - 代码示例
   - 最佳实践
   - 生产环境建议

3. **Dify 官方文档**：
   - 工作流文档：https://docs.dify.ai/guides/workflow
   - RAG 最佳实践：https://docs.dify.ai/guides/knowledge-base/best-practices

## 🤝 贡献

如果你发现问题或有改进建议：
1. 创建 Issue 描述问题
2. 提供测试用例
3. 说明期望的行为

## 📄 许可

本项目遵循 MIT 许可证。

## 🎉 总结

本项目提供了：
- ✅ 完整的问题分析
- ✅ 详细的优化方案
- ✅ 可直接使用的工作流文件
- ✅ 分步实施指南
- ✅ 生产环境最佳实践

**推荐直接使用** `rag_qa_dify_complete.yml` **开始你的 RAG QA 蒸馏之旅！** 🚀
